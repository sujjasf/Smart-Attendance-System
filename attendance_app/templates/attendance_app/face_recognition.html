{% extends 'attendance_app/base.html' %}

{% block content %}
<div class="container text-center">
    <h1 class="my-4">Face Recognition Attendance</h1>

    <div id="initial-scan">
        <p>Hold your ID QR in front of the camera and click "Scan ID".</p>
        <video id="video" width="640" height="480" autoplay></video>
        <button id="scan-id" class="btn btn-primary my-3">Scan ID</button>
    </div>

    <div id="face-verify" style="display: none;">
        <p>Welcome, <span id="student-name"></span>! Now look at the camera and click "Verify Face".</p>
        <video id="video-verify" width="640" height="480" autoplay></video>
        <button id="verify-face" class="btn btn-success my-3">Verify Face</button>
    </div>

    <div id="result" class="mt-4"></div>
</div>

<script>
    const video = document.getElementById('video');
    const videoVerify = document.getElementById('video-verify');
    const scanIdButton = document.getElementById('scan-id');
    const verifyFaceButton = document.getElementById('verify-face');
    const initialScanDiv = document.getElementById('initial-scan');
    const faceVerifyDiv = document.getElementById('face-verify');
    const studentNameSpan = document.getElementById('student-name');
    const resultDiv = document.getElementById('result');
    let studentId;

    // Get access to the camera
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
            video.srcObject = stream;
            video.play();
            videoVerify.srcObject = stream;
            videoVerify.play();
        });
    }

    scanIdButton.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function(blob) {
            const formData = new FormData();
            formData.append('image', blob, 'qr_scan.png');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:qr_scan" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    studentId = data.student_id;
                    // You might want to fetch the student's name here
                    studentNameSpan.textContent = studentId; 
                    initialScanDiv.style.display = 'none';
                    faceVerifyDiv.style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            });
        }, 'image/png');
    });

    verifyFaceButton.addEventListener('click', function() {
        const canvas = document.createElement('canvas');
        canvas.width = videoVerify.videoWidth;
        canvas.height = videoVerify.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(videoVerify, 0, 0, canvas.width, canvas.height);

        const imageDataUrl = canvas.toDataURL('image/jpeg');

        const formData = new FormData();
        formData.append('student_id', studentId);
        formData.append('image', imageDataUrl);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "attendance_app:verify_face" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.match) {
                resultDiv.innerHTML = `<div class="alert alert-success">Verification successful! Confidence: ${data.confidence.toFixed(2)}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Verification failed. ${data.error || 'Please try again.'}</div>`;
            }
            faceVerifyDiv.style.display = 'none';
        });
    });
</script>
{% endblock %}

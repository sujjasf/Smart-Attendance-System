{% extends 'attendance_app/base.html' %}

{% block content %}
<div class="container text-center">
    <h1 class="my-4">Scan QR Code</h1>

    <div id="message" class="mt-4 alert alert-info">Hold your ID in front of the camera and click Scan.</div>
    <div id="result" class="mt-4"></div>

    <video id="webcam" width="640" height="480" autoplay></video>
    <br>
    <button id="scan-button" class="btn btn-primary my-3">Scan</button>
    <button id="try-again-button" class="btn btn-secondary my-3" style="display:none;">Try Again</button>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
</div>

<script>
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const scanButton = document.getElementById('scan-button');
    const tryAgainButton = document.getElementById('try-again-button');
    const resultDiv = document.getElementById('result');
    const messageDiv = document.getElementById('message');

    let stream;

    function resetUI() {
        resultDiv.innerHTML = '';
        messageDiv.innerHTML = 'Hold your ID in front of the camera and click Scan.';
        messageDiv.className = 'mt-4 alert alert-info';
        scanButton.style.display = 'inline-block';
        tryAgainButton.style.display = 'none';
    }

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
            stream = s;
            webcam.srcObject = stream;
        })
        .catch(err => {
            console.error("Error accessing webcam: ", err);
            messageDiv.innerHTML = `Error accessing webcam. Please ensure you have a webcam connected and have granted permission.`;
            messageDiv.className = 'mt-4 alert alert-danger';
            scanButton.style.display = 'none';
        });

    function verifyFace(studentId) {
        messageDiv.innerHTML = 'QR code scanned! Now please look at the camera for face verification...';
        messageDiv.className = 'mt-4 alert alert-info';

        setTimeout(() => {
            const context = canvas.getContext('2d');
            context.drawImage(webcam, 0, 0, 640, 480);

            const imageDataUrl = canvas.toDataURL('image/jpeg');

            const formData = new FormData();
            formData.append('image', imageDataUrl);
            formData.append('student_id', studentId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:verify_face" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.match) {
                    messageDiv.innerHTML = `Welcome, ${studentId}! Attendance marked successfully.`;
                    messageDiv.className = 'mt-4 alert alert-success';
                } else {
                    messageDiv.innerHTML = `Face not recognized. Please try again.`;
                    messageDiv.className = 'mt-4 alert alert-danger';
                }
                tryAgainButton.style.display = 'inline-block';
            })
            .catch(err => {
                messageDiv.innerHTML = `An error occurred during face verification. Please try again.`;
                messageDiv.className = 'mt-4 alert alert-danger';
                tryAgainButton.style.display = 'inline-block';
            });
        }, 2000); // 2 second delay
    }

    scanButton.addEventListener('click', () => {
        scanButton.style.display = 'none';
        messageDiv.innerHTML = 'Scanning for QR code...';
        messageDiv.className = 'mt-4 alert alert-info';

        const context = canvas.getContext('2d');
        context.drawImage(webcam, 0, 0, 640, 480);

        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'qr_scan.png');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:qr_scan" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    verifyFace(data.student_id);
                } else {
                    messageDiv.innerHTML = data.message || 'No QR Code found. Please try again.';
                    messageDiv.className = 'mt-4 alert alert-danger';
                    tryAgainButton.style.display = 'inline-block';
                }
            })
            .catch(err => {
                messageDiv.innerHTML = 'An error occurred during QR scan. Please try again.';
                messageDiv.className = 'mt-4 alert alert-danger';
                tryAgainButton.style.display = 'inline-block';
            });
        }, 'image/png');
    });

    tryAgainButton.addEventListener('click', resetUI);

</script>
{% endblock %}
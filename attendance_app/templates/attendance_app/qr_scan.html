{% extends 'attendance_app/base.html' %}

{% block content %}
<div class="container text-center">
    <h1 class="my-4">Scan QR Code</h1>

    <div id="result" class="mt-4"></div>

    <video id="webcam" width="640" height="480" autoplay></video>
    <button id="scan-button" class="btn btn-primary my-3">Scan QR</button>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
</div>

<script>
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const scanButton = document.getElementById('scan-button');
    const resultDiv = document.getElementById('result');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            webcam.srcObject = stream;
        })
        .catch(err => {
            console.error("Error accessing webcam: ", err);
            resultDiv.innerHTML = `<div class="alert alert-danger">Error accessing webcam.</div>`;
        });

    scanButton.addEventListener('click', () => {
        const context = canvas.getContext('2d');
        context.drawImage(webcam, 0, 0, 640, 480);

        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'qr_scan.png');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:qr_scan" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    resultDiv.innerHTML = `<div class="alert alert-success">QR Code scanned successfully! Student ID: ${data.student_id}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            });
        }, 'image/png');
    });
</script>
{% endblock %}
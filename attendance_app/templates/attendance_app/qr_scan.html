{% extends 'attendance_app/base.html' %}

{% block content %}
<div class="container text-center">
    <h1 class="my-4">Scan QR Code</h1>

    <div id="message" class="mt-4 alert alert-info">Please hold your ID in front of the camera. Scanning...</div>
    <div id="result" class="mt-4"></div>

    <video id="webcam" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <br>
    <div id="try-again-buttons" style="display:none;">
        <button id="try-again-qr-button" class="btn btn-secondary my-3">Try Again QR Scan</button>
        <button id="try-again-face-button" class="btn btn-secondary my-3 ms-2">Try Again Face Scan</button>
    </div>

<style>
    #canvas {
        position: absolute;
        top: 160px;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none; /* Make canvas transparent to mouse events */
    }
</style>
</div>

<script>
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const tryAgainButtonsDiv = document.getElementById('try-again-buttons');
    const tryAgainQrButton = document.getElementById('try-again-qr-button');
    const tryAgainFaceButton = document.getElementById('try-again-face-button');
    const resultDiv = document.getElementById('result');
    const messageDiv = document.getElementById('message');

    let stream;
    let scanningInterval;
    let lastScannedStudentId = null; // Store the last successfully scanned student ID

    function resetUI() {
        resultDiv.innerHTML = '';
        messageDiv.innerHTML = 'Please hold your ID in front of the camera. Scanning...';
        messageDiv.className = 'mt-4 alert alert-info';
        tryAgainButtonsDiv.style.display = 'none';
        lastScannedStudentId = null;
        startScanning();
    }

    function stopScanning() {
        if (scanningInterval) {
            clearInterval(scanningInterval);
            scanningInterval = null;
        }
    }

    function startScanning() {
        stopScanning(); // Ensure no multiple intervals are running
        scanningInterval = setInterval(() => {
            scanQRCode();
        }, 2000); // Scan every 2 seconds
    }

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
            stream = s;
            webcam.srcObject = stream;
            startScanning();
        })
        .catch(err => {
            console.error("Error accessing webcam: ", err);
            messageDiv.innerHTML = `Error accessing webcam. Please ensure you have a webcam connected and have granted permission.`;
            messageDiv.className = 'mt-4 alert alert-danger';
        });

    function verifyFace(studentId) {
        lastScannedStudentId = studentId; // Store for 'Try Again Face Scan'
        messageDiv.innerHTML = `QR code for ${studentId} found! Now verifying face...`;
        messageDiv.className = 'mt-4 alert alert-info';

        setTimeout(() => {
            const context = canvas.getContext('2d');
            context.drawImage(webcam, 0, 0, 640, 480);

            const imageDataUrl = canvas.toDataURL('image/jpeg');

            const formData = new FormData();
            formData.append('image', imageDataUrl);
            formData.append('student_id', studentId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:verify_face" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawings

                if (data.face_location) {
                    const { top, right, bottom, left } = data.face_location;
                    context.strokeStyle = 'red';
                    context.lineWidth = 2;
                    context.strokeRect(left, top, right - left, bottom - top);
                }

                if (data.landmarks) {
                    context.fillStyle = 'yellow';
                    for (const landmark of data.landmarks) {
                        context.beginPath();
                        context.arc(landmark[0], landmark[1], 2, 0, 2 * Math.PI);
                        context.fill();
                    }
                }

                if (data.match) {
                    messageDiv.innerHTML = `Welcome, ${studentId}! Attendance marked successfully.`;
                    messageDiv.className = 'mt-4 alert alert-success';
                } else {
                    messageDiv.innerHTML = `Face not recognized. Please try again.`;
                    messageDiv.className = 'mt-4 alert alert-danger';
                }
                tryAgainButtonsDiv.style.display = 'block';
                tryAgainFaceButton.style.display = 'inline-block'; // Show face scan retry
            })
            .catch(err => {
                messageDiv.innerHTML = `An error occurred during face verification. Please try again.`;
                messageDiv.className = 'mt-4 alert alert-danger';
                tryAgainButtonsDiv.style.display = 'block';
                tryAgainFaceButton.style.display = 'inline-block';
            });
        }, 1000); // 1 second delay before face capture
    }

    function scanQRCode() {
        if (!stream) return;

        const context = canvas.getContext('2d');
        context.drawImage(webcam, 0, 0, 640, 480);

        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'qr_scan.png');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "attendance_app:qr_scan" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    stopScanning();
                    verifyFace(data.student_id);
                } else {
                    // No QR code found, just continue scanning silently
                }
            })
            .catch(err => {
                // Error during fetch, just continue scanning silently
                console.error("QR scan fetch error:", err);
            });
        }, 'image/png');
    }

    tryAgainQrButton.addEventListener('click', resetUI);
    tryAgainFaceButton.addEventListener('click', () => {
        if (lastScannedStudentId) {
            verifyFace(lastScannedStudentId);
        } else {
            // Should not happen if 'Try Again Face Scan' is visible
            resetUI();
        }
    });

</script>
{% endblock %}
<!DOCTYPE html>
<html>
<head>
    <title>Scan QR Code</title>
</head>
<body>
    <h1>Scan Student ID QR Code</h1>
    <video id="webcam" width="640" height="480" autoplay></video>
    <button id="scan-button">Scan QR</button>
    <p>Status: <span id="status"></span></p>
    <p>Student ID: <span id="student-id"></span></p>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

    <script>
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const scanButton = document.getElementById('scan-button');
        const statusSpan = document.getElementById('status');
        const studentIdSpan = document.getElementById('student-id');

        // Access webcam
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                webcam.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing webcam: ", err);
                statusSpan.textContent = 'Error accessing webcam.';
            });

        scanButton.addEventListener('click', () => {
            statusSpan.textContent = 'Scanning...';
            studentIdSpan.textContent = '';

            const context = canvas.getContext('2d');
            context.drawImage(webcam, 0, 0, 640, 480);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('image', blob, 'scan.png');

                fetch('/api/scan_qr/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        statusSpan.textContent = 'QR Code found!';
                        studentIdSpan.textContent = data.student_id;
                    } else if (data.status === 'no_qr') {
                        statusSpan.textContent = 'No QR Code found. Please try again.';
                    } else {
                        statusSpan.textContent = `Error: ${data.message}`;
                    }
                })
                .catch(err => {
                    console.error("Error scanning QR code: ", err);
                    statusSpan.textContent = 'An error occurred during scanning.';
                });
            }, 'image/png');
        });
    </script>
</body>
</html>
